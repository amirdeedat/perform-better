<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>School Canteen Pre-Order System</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#333}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .header{background:rgba(255,255,255,.15);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2);border-radius:20px;padding:30px;text-align:center;margin-bottom:30px;box-shadow:0 8px 32px rgba(0,0,0,.1)}
    .header h1{color:#fff;font-size:2.5rem;margin-bottom:10px;text-shadow:2px 2px 4px rgba(0,0,0,.3)}
    .header p{color:rgba(255,255,255,.9)}
    .user-toggle{display:flex;justify-content:center;gap:20px;margin-bottom:30px}
    .toggle-btn{background:rgba(255,255,255,.2);backdrop-filter:blur(10px);border:2px solid rgba(255,255,255,.3);border-radius:15px;padding:15px 30px;color:#fff;font-size:1.1rem;cursor:pointer;transition:.3s;font-weight:600}
    .toggle-btn.active{background:rgba(255,255,255,.9);color:#667eea;transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.15)}
    .panel{display:none;background:rgba(255,255,255,.95);backdrop-filter:blur(20px);border-radius:20px;padding:30px;box-shadow:0 10px 40px rgba(0,0,0,.1);border:1px solid rgba(255,255,255,.3)}
    .panel.active{display:block}
    .section{margin-bottom:30px;padding:25px;background:rgba(255,255,255,.7);border-radius:15px;border:1px solid rgba(0,0,0,.05)}
    .section h2{color:#4a5568;margin-bottom:20px;font-size:1.5rem;border-bottom:2px solid #e2e8f0;padding-bottom:10px}
    .form-group{margin-bottom:15px}
    .form-group label{display:block;margin-bottom:5px;font-weight:600;color:#4a5568}
    .form-group input,.form-group textarea,.form-group select{width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:10px;font-size:1rem}
    .btn{background:linear-gradient(45deg,#667eea,#764ba2);color:#fff;border:none;padding:12px 24px;border-radius:10px;cursor:pointer;font-weight:600;transition:.3s;margin-right:10px;margin-bottom:10px}
    .btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,.4)}
    .btn-danger{background:linear-gradient(45deg,#e53e3e,#c53030)}
    .btn-success{background:linear-gradient(45deg,#38a169,#2f855a)}
    .menu-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-top:20px}
    .menu-item,.order-item{background:rgba(255,255,255,.9);border-radius:15px;padding:20px;box-shadow:0 4px 15px rgba(0,0,0,.1);border:1px solid rgba(0,0,0,.05)}
    .menu-item h3,.order-item h3{color:#4a5568;margin-bottom:10px;font-size:1.3rem}
    .menu-item p,.order-item p{color:#718096;margin-bottom:8px}
    .price{font-size:1.2rem;font-weight:bold;color:#38a169;margin-bottom:15px}
    .quantity-controls{display:flex;align-items:center;gap:10px;margin-bottom:15px}
    .quantity-btn{background:#667eea;color:#fff;border:none;width:35px;height:35px;border-radius:50%;cursor:pointer;font-size:1.1rem;font-weight:bold}
    .quantity{font-size:1.1rem;font-weight:bold;min-width:30px;text-align:center}
    .cart-summary{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:20px;border-radius:15px;margin-top:20px}
    .cart-item{display:flex;justify-content:space-between;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,.2)}
    .cart-total{font-size:1.3rem;font-weight:bold;margin-top:15px;padding-top:15px;border-top:2px solid rgba(255,255,255,.3)}
    .status-badge{display:inline-block;padding:5px 12px;border-radius:20px;font-size:.9rem;font-weight:600;text-transform:uppercase}
    .status-pending{background:#fed7d7;color:#c53030}
    .status-preparing{background:#fef2c7;color:#d69e2e}
    .status-ready{background:#c6f6d5;color:#38a169}
    .status-completed{background:#bee3f8;color:#2b6cb0}
    .empty-state{text-align:center;padding:40px;color:#718096}
    @media (max-width:768px){.container{padding:10px}.header h1{font-size:2rem}.user-toggle{flex-direction:column;align-items:center}.menu-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üçΩÔ∏è School Canteen Pre-Order System</h1>
      <p>Order your meals in advance and skip the queue!</p>
    </div>

    <div class="user-toggle">
      <button class="toggle-btn active" onclick="switchPanel('student', event)">üë®‚Äçüéì Student Portal</button>
      <button class="toggle-btn" onclick="switchPanel('admin', event)">üë®‚Äçüíº Admin Portal</button>
      <a class="toggle-btn" href="admin.php" style="text-decoration:none;display:inline-block;">üîê Go to Admin</a>
    </div>

    <!-- Student Panel -->
    <div id="student-panel" class="panel active">
      <div class="section">
        <h2>üìÖ Today‚Äôs Menu</h2>
        <div id="menu-display" class="menu-grid"></div>
      </div>

      <div id="cart-section" class="cart-summary" style="display:none;">
        <h3>üõí Your Order</h3>
        <div id="cart-items"></div>
        <div class="cart-total">Total: RM <span id="cart-total">0.00</span></div>
        <div class="form-group" style="margin-top:12px;">
          <label for="student-name">Your Name</label>
          <input id="student-name" type="text" placeholder="e.g., Ali #3A" />
        </div>
        <button class="btn btn-success" onclick="placeOrder()">Place Order</button>
        <button class="btn" onclick="clearCart()">Clear Cart</button>
      </div>

      <div class="section">
        <h2>üìã Your Recent Orders</h2>
        <div id="student-orders"></div>
      </div>
    </div>

    <!-- Admin Panel (info only ‚Äî actual panel is in admin.php after login) -->
    <div id="admin-panel" class="panel">
      <div class="empty-state">
        <p>Use the <b>üîê Go to Admin</b> button above to login and manage menu & orders.</p>
      </div>
    </div>
  </div>

  <script>
    let cart = {}; // { itemId: qty }
    let menuItems = [];
    let myRecentOrders = []; // client-only view (optional)

    function switchPanel(panel, ev){
      document.querySelectorAll('.toggle-btn').forEach(b=>b.classList.remove('active'));
      if (ev) ev.target.classList.add('active');
      document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
      document.getElementById(panel+'-panel').classList.add('active');
      if(panel==='student'){ loadMenu(); }
    }

    async function loadMenu(){
      const menuDisplay = document.getElementById('menu-display');
      menuDisplay.innerHTML = '<div class="empty-state">Loading menu‚Ä¶</div>';
      const res = await fetch('get_menu.php');
      const data = await res.json();
      menuItems = data.menu || [];
      if(menuItems.length===0){
        menuDisplay.innerHTML = '<div class="empty-state"><i>üçΩÔ∏è</i><p>No menu items available today</p></div>';
        return;
      }
      menuDisplay.innerHTML = menuItems.map(item => `
        <div class="menu-item">
          <h3>${item.name}</h3>
          <p>${item.description || ''}</p>
          <div class="price">RM ${Number(item.price).toFixed(2)}</div>
          <div class="quantity-controls">
            <button class="quantity-btn" onclick="updateCart(${item.id}, -1)">-</button>
            <span class="quantity">${cart[item.id]||0}</span>
            <button class="quantity-btn" onclick="updateCart(${item.id}, 1)">+</button>
          </div>
          <small style="color:#718096;">Category: ${item.category}</small>
        </div>
      `).join('');
    }

    function updateCart(id, change){
      if(!cart[id]) cart[id]=0;
      cart[id]+=change;
      if(cart[id]<=0) delete cart[id];
      renderCart();
      loadMenu(); // refresh counts
    }

    function renderCart(){
      const cartSection = document.getElementById('cart-section');
      const cartItemsDiv = document.getElementById('cart-items');
      const cartTotalSpan = document.getElementById('cart-total');
      const entries = Object.entries(cart);
      if(entries.length===0){ cartSection.style.display='none'; return; }
      cartSection.style.display='block';

      let total=0;
      cartItemsDiv.innerHTML = entries.map(([id, qty])=>{
        const item = menuItems.find(m=>m.id==id);
        if(!item) return '';
        const sub = Number(item.price)*qty; total+=sub;
        return `<div class="cart-item"><span>${item.name} x${qty}</span><span>RM ${sub.toFixed(2)}</span></div>`;
      }).join('');
      cartTotalSpan.textContent = total.toFixed(2);
    }

    function clearCart(){ cart={}; renderCart(); loadMenu(); }

    async function placeOrder(){
      const name = document.getElementById('student-name').value.trim();
      if(!name){ alert('Please enter your name'); return; }
      const items = Object.entries(cart).map(([id, qty])=>{
        const it = menuItems.find(m=>m.id==id);
        return { id:Number(id), name:it?.name||'', price:Number(it?.price||0), quantity:qty };
      });
      if(items.length===0){ alert('Your cart is empty!'); return; }

      const res = await fetch('place_order.php', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ student_name:name, items })
      });
      const data = await res.json();
      if(data.success){
        alert('Order placed! Order ID: #'+data.order_id);
        myRecentOrders.unshift(data.order);
        if(myRecentOrders.length>5) myRecentOrders.pop();
        cart={}; renderCart(); loadMenu(); renderStudentOrders();
      }else{
        alert('Failed to place order.');
      }
    }

    function renderStudentOrders(){
      const div = document.getElementById('student-orders');
      if(!myRecentOrders.length){
        div.innerHTML = '<div class="empty-state"><i>üìã</i><p>No orders yet</p></div>';
        return;
      }
      div.innerHTML = myRecentOrders.map(o=>`
        <div class="order-item">
          <h3>Order #${o.id}</h3>
          <p><strong>Status:</strong> <span class="status-badge status-${o.status}">${o.status}</span></p>
          <p><strong>Ordered:</strong> ${o.created_at}</p>
          <p><strong>Items:</strong></p>
          <ul style="margin-left:20px;margin-bottom:10px;">
            ${o.items.map(it=>`<li>${it.name} x${it.quantity} - RM ${(it.price*it.quantity).toFixed(2)}</li>`).join('')}
          </ul>
          <p><strong>Total:</strong> RM ${Number(o.total).toFixed(2)}</p>
        </div>
      `).join('');
    }

    // Init
    loadMenu();
  </script>
</body>
</html>
